<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4171443996039448"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cantonese AI Tutor - Live</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #chat-log::-webkit-scrollbar, #explanation-content::-webkit-scrollbar {
            width: 8px;
        }
        #chat-log::-webkit-scrollbar-track, #explanation-content::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        #chat-log::-webkit-scrollbar-thumb, #explanation-content::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
            border: 3px solid #f1f5f9;
        }
        .message-bubble {
            max-width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #4f46e5;
            color: white;
            border-bottom-right-radius: 0.25rem;
        }
        .ai-message-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .ai-message-container {
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
        }
        .ai-message {
            background-color: #eef2ff;
            color: #3730a3;
            border-bottom-left-radius: 0.25rem;
        }
        .jyutping-text {
            font-size: 0.9rem;
            color: #64748b;
            margin-top: 0.25rem;
            padding-left: 1rem;
        }
        .english-text {
            font-size: 0.9rem;
            font-style: italic;
            color: #1e40af; /* blue-800 */
            margin-top: 0.1rem;
            padding-left: 1rem;
        }
        .action-btn {
            background: none; border: none; padding: 0; cursor: pointer;
            color: #94a3b8; /* slate-400 */
            transition: color 0.2s;
        }
        .action-btn:hover { color: #4f46e5; }
        #mic-button.is-listening {
            animation: pulse-mic 1.5s infinite;
            background-color: #fca5a5; /* red-300 */
            color: #dc2626; /* red-600 */
        }
        @keyframes pulse-mic {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        #explanation-modal { transition: opacity 0.3s ease-in-out; }
        
        #collapsible-about-text {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out;
            opacity: 1;
        }
        #collapsible-about-text.hidden {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0 !important;
        }
        #user-input {
            resize: none;
            overflow-y: hidden;
        }
    </style>
</head>
<body class="bg-gray-200 flex items-center justify-center min-h-screen">

    <div class="w-full max-w-lg mx-auto flex flex-col h-[90vh] bg-white rounded-2xl shadow-2xl">
        <!-- Header -->
        <div class="flex justify-between items-center text-center p-4 border-b border-gray-200">
            <div class="flex items-center gap-2 w-1/3">
                 <button id="reset-button" title="Reset Conversation" class="text-gray-400 hover:text-indigo-600 transition-colors p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V4a1 1 0 011-1zm10 8a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 111.885-.666A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101z" clip-rule="evenodd" /></svg>
                </button>
                 <button id="export-button" title="Export Transcript" class="text-gray-400 hover:text-indigo-600 transition-colors p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a1 1 0 00-1 1v1a1 1 0 002 0V3a1 1 0 00-1-1zM4 5a1 1 0 011-1h1a1 1 0 010 2H5a1 1 0 01-1-1zm11 0a1 1 0 00-1 1v1a1 1 0 102 0V6a1 1 0 00-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM10 15a1 1 0 00-1 1v1a1 1 0 102 0v-1a1 1 0 00-1-1z" /><path d="M3 3a1 1 0 00-1 1v12a1 1 0 001 1h14a1 1 0 001-1V4a1 1 0 00-1-1H3zm14 14H3V4h14v13z" /></svg>
                </button>
                <button id="suggest-topic-button" title="Suggest a Topic" class="text-gray-400 hover:text-indigo-600 transition-colors p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <div class="flex-1">
                <h1 class="text-2xl font-bold text-gray-800">Cantonese AI Tutor</h1>
                <p id="status-text" class="text-gray-500 text-sm mt-1 transition-colors">Your lesson is ready</p>
            </div>
            <div class="w-1/3 flex justify-end items-center gap-2">
                <label for="speed-slider" class="text-xs text-gray-500">Speed</label>
                <input type="range" id="speed-slider" min="0.5" max="2" step="0.1" value="1" class="w-20 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <span id="speed-value" class="text-xs text-gray-700 font-mono w-8 text-left">1.0x</span>
            </div>
        </div>
        
        <!-- About Section -->
        <div id="about-section" class="p-4 border-b border-gray-200 bg-slate-50 text-sm text-gray-700 cursor-pointer">
            <div id="collapsible-about-text">
                <p class="mb-2">
                    Welcome to the Cantonese AI Tutor! This tool is designed to help you practice conversational Cantonese in a friendly, interactive way. Type a message or use the microphone to speak, and the AI will respond. You can get explanations for phrases, listen again, and even export your transcript.
                    Ask the tutor for something to talk about/explore a topic or hit the ? button on the top left to suggest a random topic. Enjoy!
                </p>
                <p class="mb-2">
                    Made by <a href="about.html" class="text-indigo-600 hover:underline font-semibold">AngStation</a>.
                </p>
            </div>
            <p class="mb-3">
                If you have found use from this application, a Ko-fi would make my day!
            </p>
            <div class="flex justify-center">
                <a href='https://ko-fi.com/angstation' target='_blank'>
                    <img height='36' style='border:0px;height:36px;' src='https://storage.ko-fi.com/cdn/kofi2.png?v=3' border='0' alt='Buy Me a Coffee at ko-fi.com' />
                </a>
            </div>
        </div>

        <!-- Chat Log -->
        <div id="chat-log" class="flex-1 p-6 overflow-y-auto bg-slate-100">
            <!-- Messages will be appended here -->
        </div>

        <!-- Control Area -->
        <div class="p-4 border-t border-gray-200">
            <form id="chat-form" class="flex items-center space-x-2">
                 <textarea id="user-input" rows="1" placeholder="Type or click mic to speak..." class="w-full px-4 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                 <button id="mic-button" type="button" title="Toggle microphone" class="bg-gray-200 text-gray-600 hover:bg-gray-300 p-3 rounded-full transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                </button>
                <button id="send-button" type="submit" title="Send message" class="bg-indigo-600 text-white p-3 rounded-full hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors disabled:bg-gray-400">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
                </button>
            </form>
             <div id="mic-error" class="text-center text-red-500 mt-2 text-xs hidden">
                Speech recognition is not supported or permission was denied.
            </div>
        </div>
    </div>

    <!-- Explanation Modal -->
    <div id="explanation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50" onclick="this.classList.add('hidden')">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full flex flex-col max-h-[80vh]" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold text-indigo-700 mb-4">✨ Explanation</h3>
            <div id="explanation-content" class="text-gray-700 whitespace-pre-wrap overflow-y-auto pr-2">Loading...</div>
            <button id="close-modal-button" class="mt-6 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 w-full">Close</button>
        </div>
    </div>

    <script>
        // --- ELEMENTS ---
        const chatLog = document.getElementById('chat-log');
        const statusText = document.getElementById('status-text');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const explanationModal = document.getElementById('explanation-modal');
        const explanationContent = document.getElementById('explanation-content');
        const closeModalButton = document.getElementById('close-modal-button');
        const micButton = document.getElementById('mic-button');
        const micError = document.getElementById('mic-error');
        const resetButton = document.getElementById('reset-button');
        const exportButton = document.getElementById('export-button');
        const speedSlider = document.getElementById('speed-slider');
        const speedValue = document.getElementById('speed-value');
        const suggestTopicButton = document.getElementById('suggest-topic-button');
        const aboutSection = document.getElementById('about-section');
        const collapsibleAboutText = document.getElementById('collapsible-about-text');

        // --- STATE ---
        let cantoneseVoice = null;
        let chatHistory = [];
        let recognition;
        let isListening = false;
        let playbackRate = 1.0;
        let finalTranscriptHolder = ''; // Holds the finalized text between pauses

        // --- TOPIC SUGGESTIONS ---
        const topics = [
            "If you could be the same age forever, what age would you choose and why?",
            "Describe your family.",
            "What do you like most about your job?",
            "If you could have any job, what would it be?",
            "What was your favorite subject in school?",
            "If you could live anywhere in the world, where would you choose?",
            "Do you have any pets?",
            "What's your favorite food?",
            "What's your favorite holiday?",
            "What do people do for fun where you live?",
            "What's your average day like?",
            "How would you describe your personal style?",
            "What's your favorite game?",
            "What do you use your phone for?",
            "What's the best movie you've ever seen?",
            "What music genre is your favorite?",
            "What's your favorite book?",
            "What was the most relaxing place you've ever traveled to?",
            "What's your favorite season and why?",
            "What's your greatest accomplishment in life?",
            "Where do you see yourself in five years?"
        ];

        function suggestTopic() {
            const randomTopic = topics[Math.floor(Math.random() * topics.length)];
            addMessageToLog('user', `Let's talk about this: ${randomTopic}`);
            getAIResponse(`Let's talk about this: ${randomTopic}`);
        }

        // --- SPEECH SYNTHESIS & RECOGNITION ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

        function initVoices() {
            const voices = window.speechSynthesis.getVoices();
            cantoneseVoice = voices.find(voice => voice.lang === 'zh-HK');
            if (!cantoneseVoice) {
                console.warn("Cantonese (zh-HK) voice not found.");
                cantoneseVoice = voices.find(voice => voice.lang.startsWith('zh'));
            }
        }

        function speak(text) {
            if (!window.speechSynthesis) return;

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = cantoneseVoice;
            utterance.lang = 'zh-HK';
            utterance.rate = playbackRate;
            utterance.pitch = 1.0;

            utterance.onstart = () => setStatus('Speaking...');
            utterance.onend = () => setStatus('Your turn...');

            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
        }
        
        function skipTTS() {
            window.speechSynthesis.cancel();
            setStatus('Your turn...');
        }

        function setupSpeechRecognition() {
            if (!SpeechRecognition) {
                micButton.disabled = true;
                micError.classList.remove('hidden');
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'yue-Hant-HK';

            recognition.onresult = (event) => {
                let interim_transcript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        let final_part = event.results[i][0].transcript;
                        final_part = final_part.replace(/\speriod/ig, '.');
                        final_part = final_part.replace(/\scomma/ig, ',');
                        final_part = final_part.replace(/\squestion mark/ig, '?');
                        final_part = final_part.replace(/\sexclamation mark/ig, '!');
                        final_part = final_part.replace(/\sexclamation point/ig, '!');
                        final_part = final_part.replace(/句號/g, '.');
                        final_part = final_part.replace(/逗號/g, ',');
                        final_part = final_part.replace(/問號/g, '?');
                        final_part = final_part.replace(/感嘆號/g, '!');
                        finalTranscriptHolder += final_part;
                    } else {
                        interim_transcript += event.results[i][0].transcript;
                    }
                }
                userInput.value = finalTranscriptHolder + interim_transcript;
            };

            recognition.onstart = () => {
                isListening = true;
                micButton.classList.add('is-listening');
                setStatus('Listening... (click mic to stop)');
            };

            recognition.onend = () => {
                isListening = false;
                micButton.classList.remove('is-listening');
                setStatus('Your turn...');
                finalTranscriptHolder = userInput.value;
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                micError.textContent = `Error: ${event.error}.`;
                micError.classList.remove('hidden');
                isListening = false;
                micButton.classList.remove('is-listening');
            };
        }

        // --- UI & CHAT LOGIC ---
        function setStatus(text) {
            statusText.textContent = text;
        }

        function addMessageToLog(sender, message) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `w-full flex mb-4 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;

            if (sender === 'user') {
                const messageBubble = document.createElement('div');
                messageBubble.className = 'message-bubble user-message max-w-[75%]';
                messageBubble.textContent = message;
                messageWrapper.appendChild(messageBubble);
            } else { // AI message
                const parts = message.split('|').map(s => s.trim());
                const isCantoneseFormat = parts.length === 3;
                const textToSpeak = isCantoneseFormat ? parts[0] : message;

                const aiMessageWrapper = document.createElement('div');
                aiMessageWrapper.className = 'ai-message-wrapper max-w-[75%]';
                const aiContainer = document.createElement('div');
                aiContainer.className = 'ai-message-container';

                const messageBubble = document.createElement('div');
                messageBubble.className = 'message-bubble ai-message';
                messageBubble.textContent = textToSpeak;

                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex flex-col justify-center items-center gap-2 pl-1';

                const replayButton = document.createElement('button');
                replayButton.className = 'action-btn';
                replayButton.title = 'Hear again';
                replayButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>`;
                replayButton.onclick = () => speak(textToSpeak);

                const skipButton = document.createElement('button');
                skipButton.className = 'action-btn';
                skipButton.title = 'Skip TTS';
                skipButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10.293 15.707a1 1 0 010-1.414L14.586 10l-4.293-4.293a1 1 0 111.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M4.293 15.707a1 1 0 010-1.414L8.586 10 4.293 5.707a1 1 0 011.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>`;
                skipButton.onclick = () => skipTTS();

                const explainButton = document.createElement('button');
                explainButton.className = 'action-btn';
                explainButton.title = 'Explain this phrase';
                explainButton.innerHTML = `✨`;
                explainButton.onclick = () => getExplanation(textToSpeak);

                buttonContainer.appendChild(replayButton);
                buttonContainer.appendChild(skipButton);
                buttonContainer.appendChild(explainButton);

                aiContainer.appendChild(messageBubble);
                aiContainer.appendChild(buttonContainer);
                aiMessageWrapper.appendChild(aiContainer);

                if (isCantoneseFormat) {
                    const jyutpingElement = document.createElement('div');
                    jyutpingElement.className = 'jyutping-text';
                    jyutpingElement.textContent = parts[1];
                    aiMessageWrapper.appendChild(jyutpingElement);

                    const englishElement = document.createElement('div');
                    englishElement.className = 'english-text';
                    englishElement.textContent = parts[2];
                    aiMessageWrapper.appendChild(englishElement);
                }

                messageWrapper.appendChild(aiMessageWrapper);
            }

            chatLog.appendChild(messageWrapper);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        // --- GEMINI API CALLS ---
        async function callGemini(prompt) {
            const apiUrl = '/.netlify/functions/get-ai-response';
            const payload = {
                contents: prompt,
                safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                ]
            };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API error: ${response.statusText}`);
            const result = await response.json();
            return result.candidates[0].content.parts[0].text;
        }

        async function getAIResponse(userText) {
            setStatus('Thinking...');
            sendButton.disabled = true;
            micButton.disabled = true;

            chatHistory.push({ role: "user", parts: [{ text: userText }] });

            const tutorPrompt = [
                { role: "user", parts: [{ text: "You are a friendly, bilingual Cantonese tutor. Your primary goal is to help, your student practice and learn conversational Cantonese. However, you should switch to English for complex explanations, to clarify something, or if the student seems confused or asks for help in English. When you reply in Cantonese, ALWAYS use this exact format: 'Cantonese Characters | Jyutping Romanization | English Translation'. When you reply in English, just provide the plain English text without any special formatting."}]},
                { role: "model", parts: [{ text: "Okay, I understand. I'm ready to help!"}]},
                ...chatHistory.slice(-10)
            ];

            try {
                const aiText = await callGemini(tutorPrompt); 
                chatHistory.push({ role: "model", parts: [{ text: aiText }] });
                addMessageToLog('ai', aiText);
                const textToSpeak = aiText.includes('|') ? aiText.split('|')[0].trim() : aiText;
                speak(textToSpeak);
            } catch (error) {
                console.error("Error fetching AI response:", error);
                const errorMsg = "Sorry, an error occurred. Please try again.";
                addMessageToLog('ai', errorMsg);
                speak(errorMsg);
            } finally {
                sendButton.disabled = false;
                micButton.disabled = false;
            }
        }

        async function getExplanation(textToExplain) {
            setStatus('Explaining...');
            explanationContent.textContent = 'Loading...';
            explanationModal.classList.remove('hidden');
            const prompt = [{ role: "user", parts: [{ text: `You are a Cantonese tutor. Explain the following sentence to a beginner. Break it down word-by-word, explain the grammar, and provide the Jyutping pronunciation. Keep it simple and clear. The sentence is: "${textToExplain}"` }] }];
            try {
                const explanation = await callGemini(prompt);
                explanationContent.textContent = explanation;
            } catch (error) {
                explanationContent.textContent = 'Sorry, I could not get an explanation.';
            }
        }

        function resetConversation() {
            chatLog.innerHTML = '';
            const greeting = "你好！隨時都可以開始傾偈。 | nei5 hou2! ceoi4 si4 dou1 ho2 ji5 hoi1 ci2 king1 gai2. | Hello! You can start chatting any time.";
            chatHistory = [
                { role: "user", parts: [{ text: "Start the conversation." }] },
                { role: "model", parts: [{ text: greeting }] }
            ];
            addMessageToLog('ai', greeting);
            setStatus('Your lesson is ready');
        }

        function exportTranscript() {
            if (chatHistory.length <= 1) {
                alert("Nothing to export yet!");
                return;
            }

            const lines = ['Cantonese Tutor Transcript\n==========================\n'];
            const conversation = chatHistory.slice(1); 

            conversation.forEach(entry => {
                if (entry.role === 'user') {
                    lines.push(`You: ${entry.parts[0].text}\n`);
                } else if (entry.role === 'model') {
                    const message = entry.parts[0].text;
                    const parts = message.split('|').map(s => s.trim());
                    if (parts.length === 3) {
                        lines.push(`Tutor: ${parts[0]}\n       (Jyutping: ${parts[1]})\n       (English: ${parts[2]})\n`);
                    } else {
                        lines.push(`Tutor: ${message}\n`);
                    }
                }
                lines.push('---\n');
            });

            const blob = new Blob([lines.join('\n')], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'cantonese-transcript.txt';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // --- EVENT LISTENERS ---
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const userText = userInput.value.trim();
            if (!userText) return;
            addMessageToLog('user', userText);
            finalTranscriptHolder = ''; 
            userInput.value = '';
            userInput.style.height = 'auto'; // Reset height
            getAIResponse(userText);
        });

        micButton.addEventListener('click', () => {
            if (isListening) {
                recognition.stop();
            } else {
                finalTranscriptHolder = ''; 
                userInput.value = '';
                recognition.start();
            }
        });

        speedSlider.addEventListener('input', (e) => {
            playbackRate = parseFloat(e.target.value);
            speedValue.textContent = `${playbackRate.toFixed(1)}x`;
        });
        
        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto';
            const newHeight = Math.min(userInput.scrollHeight, 120); // Max height of 120px
            userInput.style.height = `${newHeight}px`;
        });

        resetButton.addEventListener('click', resetConversation);
        exportButton.addEventListener('click', exportTranscript);
        suggestTopicButton.addEventListener('click', suggestTopic);
        closeModalButton.addEventListener('click', () => explanationModal.classList.add('hidden'));
        aboutSection.addEventListener('click', () => {
            collapsibleAboutText.classList.toggle('hidden');
        });

        // --- INITIALIZATION ---
        window.onload = () => {
            window.speechSynthesis.onvoiceschanged = initVoices;
            initVoices();
            setupSpeechRecognition();
            resetConversation();
        };
    </script>
    
</body>
</html>
